---
title: Introduction à R pour<br>Épidémiologie appliquée
subtitle: Pivoting donnees
author: '2022'
date: '[contact@appliedepi.org](mailto:contact@appliedepi.org)'
output:
  xaringan::moon_reader:
    seal: false
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    css: xaringan-themer.css
params:
  lang: fr
---

class: center, middle, inverse, title-slide

```{r, eval=F, echo=F, include=F}
# Must do in order to render.

pacman::p_load(xaringan)
devtools::install_github("gadenbuie/xaringanExtra")
remotes::install_github("mitchelloharawild/icons")
icons::download_fontawesome()

# Render with xaringan::infinite_moon_reader()
# Slides will appear in viewer, and will update as you edit/save
```

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.retina = 3  ## retina more effective than w/h (according to twitter)
                      # fig.width = 16, 
                      # fig.height = 10
                      )
## I dont know why this is included in the example xaringan slide 
## but is something to do with background images
options(htmltools.dir.version = FALSE)

## install and load necessary packages 
pacman::p_load(
  rio,        # importing donnees  
  here,       # relative file pathways  
  janitor,    # donnees cleaning and tables
  lubridate,  # working with dates
  tidyverse,  # donnees management and visualization
  gtsummary,  # summary tables
  flextable,  # make pivot images 
  flair,      # slides color text
  kableExtra, # for output tables
  xaringanthemer  # for styling presentation 
)


# donnees prep --------------------------------------------------------------------
# linelist_raw <- rio::import(here::here("donnees", "linelist_raw.xlsx"))
surv <- rio::import(here::here("data", "linelist_combinee_20141201.rds"))

# gen <- googlesheets4::read_sheet(
#   "https://docs.google.com/spreadsheets/d/1-Xqv5xvakmhKSxipVP6a9GF3H54RN-rbilhdNhPHx6M/edit#gid=998182281",
#   range = "generic") %>%
#   clean_names()
# 
# mod7_2 <- googlesheets4::read_sheet(
#   "https://docs.google.com/spreadsheets/d/1-Xqv5xvakmhKSxipVP6a9GF3H54RN-rbilhdNhPHx6M/edit#gid=998182281",
#   range = "mod7_2", col_types = "c") %>%
#   clean_names()
```

```{r xaringan-themer, include=FALSE}

## define presentation colours (theme) using {xaringanthemer} package 
## https://pkg.garrickadenbuie.com/xaringanthemer/articles/xaringanthemer.html

## epirhandbook logo colours: 
  ## blue: "#00538c"
  ## green: "#007732"
  ## lighter green: "#48a878"

## see ?style_mono_accent for all the things can customise
style_mono_accent(
  base_color = "#00538c", 
  link_color = "#48a878", 
  ## add logo to the title page (bit bigger)
  title_slide_background_image = "https://brutes.githubusercontent.com/appliedepi/slides/master/images/logo.png", 
  title_slide_background_position = "95% 95%", 
  title_slide_background_size = "25%", 
  ## add logo to all following slides
  background_image = "https://brutes.githubusercontent.com/appliedepi/slides/master/images/logo.png", 
  background_size = "10%",
  background_position = "100% 0%"
)
```

```{css, echo=F}
    .remark-slide table{
      border: none
    }
    .remark-slide-table {
      
    }
    tr:first-child {
      border-top: none;
  }
    tr:last-child {
    border-bottom: none;
  }
```

# Introduction à R pour l'épidémiologie appliquée

### Pivoter les données

contact@appliedepi.org
---

# Restructuration des données

*pivoter, remodeler, fondre, couler, transformer...* les jeux de données

```{r, eval=TRUE, echo=FALSE, out.height="100%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.
knitr::include_graphics(xfun::relative_path(here::here("images", "joins_pivots", "Pivoting_500x500.png")))
```

---

# Qu'est-ce que le pivot ?

- Les *tableaux croisés dynamiques Excel* sont un moyen de résumer et d'agréger des données

--

- Dans R, **pivoter** un jeu de données a une **signification différente**

--

- Considérez-le comme une *restructuration* ou un *remodelage* du jeu de données

--

- Nous utiliserons les fonctions `pivot_wider()` et `pivot_longer()` du paquet {tidyr}

--

- Vous verrez souvent des exemples utilisant des fonctions différentes provenant d'autres paquets :
  - `melt()` et `cast()` de {reshape2}
  - `gather()` et `spread()` ancêtres des fonctions `pivot_()` de {tidyr}
  - `melt()` et `dcast()` de {data.table}

---

# Mettre de l'ordre dans les données

Vous souvennez-vous des 3 principes des "données organisées" ?

--

1. Chaque **valeur** doit avoir sa propre **cellule**

--

2. Chaque **variable** doit avoir sa propre **colonne**

--

3. Chaque **observation** doit avoir sa propre **rangée**

---

# Terminologie

Structurellement, les "jeux de données" sur R sont constitués de **colonnes** et **rangées**.

--

Cependant , les concepts de **"variables"** et **"observations"** sont plus *abstraits* :

- Les **variables** mesurent un *attribut sous-jacent* (par exemple l'âge, résultat ou date d'apparition)
- Les **observations** sont une *unité d'analyse*

--

Idéalement, ceux-ci peuvent s'aligner : **colonnes = variables** et **lignes = observations**

```{r, eval=TRUE, echo=FALSE, out.height="65%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.
knitr::include_graphics(xfun::relative_path(here::here("images", "data_cleaning", paste0("tidy_image_", params$lang, ".png"))))
```

.footnote[Source de l'image : [R for Data Science](https://r4ds.had.co.nz/tidy-donnees.html)]

---

# Le pivot long

.pull-left[
La saisie des données se fait souvent en format "large"

```{r}
exemple <- tribble(
     ~pays, ~`1999`, ~`2000`,     ~`2001`,  ~`2002`, 
     "Nigeria",   8000,    7500,        9250,      10200,    
     "Inde",    20100,  25650,      26800,    27255,
     "Bresil",   4500,    5120,        5100,   5860)
          
exemple %>%
  knitr::kable()
```

- Les caractéristiques de chaque personne sont stockées sur une seule ligne
- Utile pour la présentation
- **Pas** idéal pour certains types d'analyse.
  ]

--
.pull-right[
**Plus facile à analyser en format "long"**

```{r}
exemple %>%
  pivot_longer(cols=2:5, names_to="annee", values_to = "cas") %>% 
     knitr::kable()
```

]

---

# Exemple {ggplot2}

Comment représenter les cas dans le temps pour les trois pays ?

```{r}
exemple %>%
  knitr::kable()
```

```{r, eval=F, echo=T}
ggplot(data = exemple,
       mapping = aes(x = ???, y = ???))+
     geom_line()
```

---

# Le pivot long

.pull-left[

```{r}
exemple %>% 
  qflextable() %>% 
  bg(j = 1, i = 1, part = "header", bg = "white") %>%          # backgrounds
  bg(j = 2:5, i = 1, part = "header", bg = "orange") 
  
 # bg(j = 1, i = 1:3, part = "body", bg = "#ADD8E6") %>% 
 # bg(j = 2:5, i = 1:3, part = "body", bg = "#31a354") 
     
  #flextable::color(i = 1:3, j = 1:5, "white", part = "body")    # white text
```

- Ces **noms de colonnes seront pivotés**

]

---

# Le pivot long

.pull-left[

```{r}
exemple %>% 
  qflextable() %>% 
  bg(j = 1, i = 1, part = "header", bg = "white") %>%          # backgrounds
  bg(j = 2:5, i = 1, part = "header", bg = "orange") %>% 
  
  #bg(j = 1, i = 1:3, part = "body", bg = "#ADD8E6") %>% 
  bg(j = 2:5, i = 1:3, part = "body", bg = "#31a354") 
     
  #flextable::color(i = 1:3, j = 1:5, "white", part = "body")    # white text
```

- Ces **valeurs seront réarrangées**

]

---

# Le pivot long

.pull-left[

```{r}
exemple %>% 
  qflextable() %>% 
  bg(j = 1, i = 1, part = "header", bg = "white") %>%          # backgrounds
  bg(j = 2:5, i = 1, part = "header", bg = "orange") %>% 
  
  bg(j = 1, i = 1:3, part = "body", bg = "#ADD8E6") %>% 
  bg(j = 2:5, i = 1:3, part = "body", bg = "#31a354") 
     
  #flextable::color(i = 1:3, j = 1:5, "white", part = "body")    # white text
```

- Ces **identifiants seront répliqués**

]

---

# Le pivot long

.pull-left[

```{r}
exemple %>% 
  qflextable() %>% 
  bg(j = 1, i = 1, part = "header", bg = "white") %>%          # backgrounds
  bg(j = 2:5, i = 1, part = "header", bg = "orange") %>% 
  
  bg(j = 1, i = 1:3, part = "body", bg = "#ADD8E6") %>% 
  bg(j = 2:5, i = 1:3, part = "body", bg = "#31a354") 
     
  #flextable::color(i = 1:3, j = 1:5, "white", part = "body")    # white text
```

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "joins_pivots", "pivot_command.png")))
```

- Il faut préciser le nom des colonnes à pivoter
- Il faut également fournir 2 **nouveaux noms de colonnes**

]

.pull-right[

```{r}
exemple %>% 
  pivot_longer(cols=2:5, names_to="annee", values_to = "cas") %>% 
  
  qflextable() %>% 
  bg(j = 1, i = 1, part = "header", bg = "white") %>% 
  bg(j = 2, i = 1, part = "header", bg = "yellow") %>% 
  bg(j = 3, i = 1, part = "header", bg = "#CBC3E3") %>% 

  #bg(j = 2:3, i = 1, part = "header", bg = "yellow") %>% 
  
  bg(j = 1, i = 1:12, part = "body", bg = "#ADD8E6") %>% 
  bg(j = 2, i = 1:12, part = "body", bg = "orange") %>% 
  bg(j = 3, i = 1:12, part = "body", bg = "#31a354") 

  #flextable::color(j = 1, i = 1:12, "white", part = "body") %>% 
  #flextable::color(j = 3, i = 1:12, "white", part = "body")

```

]

```{r pivot, eval=F}
# Create pivot command (switch to include = F)
exemple %>% 
  pivot_longer(
       cols = `1999`:`2002`,
       names_to = "annee",
       values_to = "cas")
```

```{r pivot_flair, echo=F, eval=F}
# remove eval = F
# use to create image of pivot command
decorate("pivot") %>%
  flair("`1999`:`2002`", background = "orange") %>%
  flair("annee", background = "yellow") %>%
  flair("cas", background = "#CBC3E3") %>%
  knit_print.with_flair()
```

---

# Commande ggplot

.pull-left[

```{r, eval=F, echo=T}
exemple %>%
  pivot_longer(
       cols = `1999`:`2002`,
       names_to = "annee",
       values_to = "cas") %>%
     
  ggplot(mapping = aes(
*           x = annee,
*           y = cas,
*           color = country,
*           group = country))+
  geom_line()
```

**Note :** cet exemple est inclus dans votre dossier de cours sous la forme d'un script R intitulé "exemple\_pivot.R" dans le sous-dossier "ebola/scripts/examples".

]

.pull-right[

```{r, eval=T, echo=F}
exemple %>%
  pivot_longer(
       cols = `1999`:`2002`,
       names_to = "annee",
       values_to = "cas") %>%
     
  ggplot(mapping = aes(
           x = annee,
           y = cas,
           color = country,
           group = country))+
  geom_line(size = 2)+
  theme_classic(base_size = 16)
```

]

---

# Le pivot large

Nous n'aborderons pas le pivot large (`pivot_wider()`) dans ce cours, car il n'est pas aussi fréquemment utilisé.

Vous pouvez explorer plusieurs exemples dans ces chapitres du Manuel Epi R :

- [Pivoter les données](https://epirhandbook.com/en/pivoting-donnees.html#long-to-wide)
- [Tableaux descriptifs avec {dplyr}](https://epirhandbook.com/en/descriptive-tables.html#tbls_pivot_wider)

```{r, eval=TRUE, echo=FALSE, out.height="100%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "joins_pivots", paste0("pivot_wider_new_", params$lang, ".png"))))

```

---

class: inverse, center, middle

# Exercice !

Allez sur le site du cours 
Ouvrez l'exercice du module 8, partie 2, et connectez-vous   
Suivez les instructions pour retourner à votre projet R "ebola" et continuer à coder dans votre script RMD 
Informez un instructeur si vous n'êtes pas sûr.e.s de ce que vous devez faire

```{r, eval=TRUE, echo=FALSE, out.width="50%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "breakout", "window.png")))
```


