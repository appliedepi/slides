---
title: Introduction à R pour<br>Épidémiologie appliquée
subtitle: Routine reports with {rmarkdown}
date: '[contact@appliedepi.org](mailto:contact@appliedepi.org)'
output:
  xaringan::moon_reader:
    seal: true
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    css: xaringan-themer.css
params:
  lang: en
---

```{r, eval=F, echo=F, include=F}
# Must do in order to render.

pacman::p_load(xaringan)
devtools::install_github("gadenbuie/xaringanExtra")
remotes::install_github("mitchelloharawild/icons")
icons::download_fontawesome()





# Render with xaringan::infinite_moon_reader()
# Slides will appear in viewer, and will update as you edit/save
```

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.retina = 3  ## retina more effective than w/h (according to twitter)
                      # fig.width = 16, 
                      # fig.height = 10
                      )
## I dont know why this is included in the example xaringan slide 
## but is something to do with background images
options(htmltools.dir.version = FALSE)
xaringanExtra::use_panelset()
xaringanExtra::use_tile_view()

## install and load necessary packages 
pacman::p_load(
  rio,        # importing data  
  here,       # relative file pathways  
  janitor,    # data cleaning and tables
  lubridate,  # working with dates
  sf,         # spatial
  scales,     # comma
  epikit,     # helpers
  ggspatial,  # spatial
  kableExtra, # for output tables
  xaringanthemer,  # for styling presentation
  tidyverse  # data management and visualization

)

## load packages from github
pacman::p_load_gh(
     "R4IDSR/epichecks"   # bivariate colour maps 
)


# data prep --------------------------------------------------------------------
surv <- rio::import(here::here("data", "surveillance_linelist_clean_20141201.rds"))

# gen <- googlesheets4::read_sheet(
#   "https://docs.google.com/spreadsheets/d/1-Xqv5xvakmhKSxipVP6a9GF3H54RN-rbilhdNhPHx6M/edit#gid=998182281",
#   range = "generic", col_types = "c") %>%
#   clean_names()
# 
# mod9 <- googlesheets4::read_sheet(
#   "https://docs.google.com/spreadsheets/d/1-Xqv5xvakmhKSxipVP6a9GF3H54RN-rbilhdNhPHx6M/edit#gid=998182281",
#   range = "mod9", col_types = "c") %>%
#   clean_names()
```

```{r xaringan-themer, include=FALSE}

## define presentation colours (theme) using {xaringanthemer} package 
## https://pkg.garrickadenbuie.com/xaringanthemer/articles/xaringanthemer.html

## epirhandbook logo colors: 
  ## blue: "#00538c"
  ## green: "#007732"
  ## lighter green: "#48a878"

## see ?style_mono_accent for all the things can customise
style_mono_accent(
  base_color = "#00538c", 
  link_color = "#48a878", 
  ## add logo to the title page (bit bigger)
  title_slide_background_image = "https://raw.githubusercontent.com/appliedepi/slides/master/images/logo.png", 
  title_slide_background_position = "95% 95%", 
  title_slide_background_size = "25%", 
  ## add logo to all following slides
  background_image = "https://raw.githubusercontent.com/appliedepi/slides/master/images/logo.png", 
  background_size = "10%",
  background_position = "100% 0%"
)
```

```{css, echo=F}
    .remark-code {
      font-size: 70%;
    }
    .remark-slide table{
      border: none
    }
    .remark-slide-table {
      
    }
    tr:first-child {
      border-top: none;
    }
    tr:last-child {
    border-bottom: none;
    }
```

# Aujourd'hui : objectifs et calendrier

- Comprendre le markdown R comme un outil pour faire des rapports de routine.

- Explorer la variété de formats et d'intégrations pour les rapports R markdown.

- Convertir le code de ton étude de cas Ebola en un rapport R markdown

- Rendre le script R Markdown dynamiquement propice aux mises à jour des données.

```{r, echo=FALSE, warning=F, message=F}
outline <- dplyr::tribble(
  ~Time, ~Topic,
  "30 minutes", "R markdown slides & demonstration",
  "2.5 hours", "Create your Ebola situation report",
  "30 minutes", "Debrief"
)

outline %>% 
  flextable::qflextable() %>% 
  flextable::add_footer_lines("Take breaks as you wish during the exercise")
```

---

# Santé publique et rapports de routine : une histoire d'amour

.pull-left[

En santé publique, nous aimons nos rapports.

- Rapports sur la situation des épidémies
- Diaporamas hebdomadaires
- Briefing exécutif
- Rapports destinés au public
- Enquêtes sur la santé communautaire
- Analyses d'enquêtes sur la vaccination
- ...

**La production manuelle est laborieuse et sujette aux erreurs humaines**

]

.pull-right[

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "welcome", "automated_reports.png")))
```

]

---

# Santé publique et rapports de routine : une histoire d'amour

.pull-left[

Nous devons souvent les produire pour de nombreuses sous-populations :

- Quartier, code postal
- Comté, district, province, état, pays
- Sous-populations ethniques ou professionnelles
- Groupes à haut risque
- Hebdomadaire, trimestriel, annuel

**La production manuelle est laborieuse et sujette à l'erreur humaine**

]

.pull-right[

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "welcome", "automated_reports.png")))
```

]

---

# "Automatisation" v. l'œil humain

.pull-left[

"L'apprentissage automatique" et "l'IA" sont des sujets d'actualité en ce moment.

Mais dans la plupart des scénarios de santé publique et d'épidémiologie appliquée, l'interprétation correcte des tendances nécessite également :

- L'expérience
- Connaissance du contexte local
- Compréhension du flux de données et de ses limites

Comment as-tu expérimenté les limites de l'"automatisation" dans ton travail ?

]

.pull-right[

```{r, eval=TRUE, echo=FALSE, out.width="75%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "human_robot.png")))
```

]

---

class: inverse, center, middle

# R markdown

## Un endroit pour l'écriture basée sur les données.</br>Du code, du texte et des sorties ensemble.

---

# Diverses sorties

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "rmarkdown_overview.png")))
```

---

# Tableaux de bord

{rmarkdown} peut produire des tableaux de bord simples à envoyer par courriel ou à héberger en ligne.

```{r, eval=TRUE, echo=FALSE, out.width="75%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "flexdashboard_output.png")))
```

.footnote[Inscris-toi à notre cours de Markdown R avancé ou consulte la rubrique [Epi R Handbook chapitre](https://epirhandbook.com/en/dashboards-with-r-markdown.html)!]

---

class: inverse, center, middle

# Même ces diapositives ont été réalisées avec R Markdown !

```{r, eval=TRUE, echo=FALSE, out.width="75%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "even_slides.png")))
```

.footnote [Voir le {xaringan} et inscris-toi à notre cours avancé de R Markdown].

---

# Vue d'ensemble

**Le script entier est maintenant un document** qui intègre **des phrases de texte** avec des phrases **code R** et son **sorties**. Tout est mis à jour lorsque le script est exécuté.

```{r, eval=TRUE, echo=FALSE, out.width="100%"}

knitr::include_graphics(here::here("images", "rmd_1", "rmarkdown_translation.png"))

```

---

# Vocabulaire

- **Markdown (.md)** - un "langage" non spécifique à R, qui permet de convertir ton texte brut en html et autres formats.

--

- **R Markdown (.Rmd)** - une variante de markdown spécifique à R

--

- {rmarkdown} un paquetage R utilisé pour rendre le markdown (texte) dans le fichier markdown R dans la sortie désirée.

--

- {knitr} - un paquet R qui lit les morceaux de code R et les intègre au document.

--

- **Pandoc** - un logiciel séparé (mais fourni avec RStudio) qui convertit le résultat en word/pdf/powerpoint, etc.

```{r, eval=TRUE, echo=FALSE, out.width="75%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "0_rmd.png")))
```

.footnote[image [source](https://rmarkdown.rstudio.com/authoring_quick_tour.html)]

???
Ce processus se déroule en arrière-plan, tu n'as donc pas besoin de connaître toutes ces étapes. Cependant, il se peut que tu rencontres ces noms.

Le fichier .Rmd est transmis à knitr, qui exécute les morceaux de code R et crée un nouveau fichier .md (markdown) qui comprend le code R et son rendu. Le fichier .md est ensuite traité par pandoc pour créer le produit fini : un document Microsoft Word, un fichier HTML, un document powerpoint, un pdf, etc.

---

class: centre, middle

# Morceaux de code R

---

# Morceaux de code

Dans R Markdown, ton code se présente sous forme de "chunks" - de minuscules morceaux de script R dans le document. Les morceaux de code sont destinés à des tâches discrètes (par exemple, charger des paquets, importer des données, nettoyer des données).

.pull-left[
Parties d'un morceau de code :

- 3 "backticks" et `{r}` commencent le morceau
- **Code R au milieu**
- 3 backticks ferment le chunk

*Raccourci clavier : Ctrl + Alt + i*  
*Raccourci du menu : Code -> Insérer un morceau*

]

.pull-right[

````r
```{r}`r ''`

R code will be here

```
````

</br>

````r
```{r}`r ''`

More R code will be here.

```
````

]

---

# Script R normal (.R)

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "r_script.png")))
```

---

# Morceaux de code R Markdown (.Rmd)

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "rmd_script.png")))
```

---

# La sortie du rapport

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "word_simple.png")))
```

---

class: inverse, center, middle

# Texte

---

# Texte

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "rmd_text.png")))
```

---
# Text 

.panelset[
.panel[.panel-name[To get this]
A normal text sentence.  
*Here is some text to be italicized*      
**Here is some text to be written in bold**   

* Bullet point 1   
* Bullet point 2  

]
.panel[.panel-name[Type this]
A normal text sentence.  
`*Here is some text to be italicized*`  
`**Here is some text to be written in bold**`

`* Bullet point 1`  
`* Bullet point 2`    

]
]

.footnote[See more RMarkdown formatting [here](https://rmarkdown.rstudio.com/authoring_basics.html)]



---
# Report headings and sections
.panelset[
.panel[.panel-name[To get this]
  
# Big heading  
## Smaller headings
### Smaller headings
#### Even smaller headings

]
.panel[.panel-name[Type this]


`# Big heading`  
`## Smaller headings`  
`### Smaller headings`  
`#### Even smaller headings`  



]
]

---

# Ajoute du texte au rapport

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "word_text.png")))
```

---

class: inverse, center, middle

# Paramètres

---

# Paramètres YAML

Cette section à la page **en haut du document** spécifie les paramètres de base de la production.

Les paramètres sont écrits en `key: value` paires.

```{asis}
---
title: "Ebola Outbreak Situation Report"
author: "Neale Batra"
output: word_document
date: "`r Sys.Date()`"
---
```

???
Note qu'il commence et se termine par trois tirets, et que l'emplacement des espaces et des deux points est très important.

---

# Le morceau "setup

**Bloc "options"** ajuste la façon dont le code R et ses sorties sont affichés dans le rapport.

Les `setup` situé en haut du document R Markdown utilise un {knitr} pour définir le **par** "options" par défaut pour tous les morceaux.

- Exécute des morceaux : `eval = TRUE`
- Affiche le code dans le rapport : `echo = TRUE`
- Afficher les avertissements dans le rapport : `warning = TRUE`
- Afficher les erreurs dans le rapport : `error = TRUE`
- Afficher les résultats dans le rapport : `include = TRUE`

Ci-dessous, la valeur par défaut est définie de manière à ce que le code R soit imprimé dans le rapport, mais que les avertissements et les messages d'erreur ne le soient pas.

````r
```{r setup, include=FALSE}`r ''` 

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE)

```
````

---

# Options de découpage

Pour remplacer les valeurs par défaut, tu peux ajuster les options de chaque morceau :

.pull-left[
Ajuste les "options" du bloc à l'intérieur de l'élément `{r}`

- Exécute le morceau : `eval = TRUE`
- Montre le code : `echo = TRUE`
- Afficher les avertissements : `warning = TRUE`
- Afficher les erreurs : `error = TRUE`
- Afficher les résultats : `include = TRUE`

Note les virgules entre chaque option.

]

.pull-right[

````r
```{r packages, echo = FALSE, warning = FALSE}`r ''` 

pacman::p_load(
  rio,      # import/export
  here,     # file paths
  janitor,  # cleaning & simple tables
  tidyverse # data management & viz
)

```
````

]

En savoir plus sur les options des morceaux de code [ici](https://rmarkdown.rstudio.com/lesson-3.html)

???
Les noms de morceaux ne peuvent pas contenir d'espaces

---

# Exécuter le document

Appuie sur le bouton "tricoter" en haut. Utilise la liste déroulante pour les options.

```{r, eval=TRUE, echo=FALSE, out.width="10%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "4_knitbutton.png")))
```

Les progrès s'affichent dans le volet "R Markdown" (à côté de la console R).

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "4_progress.png")))
```

Par défaut, le résultat sera enregistré à côté de ton fichier .Rmd.

???
Tu trouveras dans le manuel des options permettant de créer une "usine à rapports" où il est plus facile de cataloguer les résultats de nombreux rapports différents dans des dossiers datés et horodatés.

---

class: inverse, center, middle

# Démonstration en direct

```{r, eval=TRUE, echo=FALSE, out.width="50%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "functions_packages", "piano_man.jpg")))
```

---

class: inverse, center, middle

# Conseils plus avancés

---

# Code R en ligne

Ce code écrit en ligne et le texte :

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("verbatim_inline_1_1_", params$lang, ".png"))))
```

produit ceci :

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("verbatim_inline_1_2_", params$lang, ".png"))))
```

---

# Code R en ligne

Ce code écrit en ligne et le texte :

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("verbatim_inline_2_1_", params$lang, ".png"))))
```

produit ceci :

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("verbatim_inline_2_2_", params$lang, ".png"))))
```

---

# Fonctions d'aide

{epikit}

```{r, eval=TRUE, echo=TRUE}
epikit::fmt_count(surv, is.na(date_onset))
```

```{r, eval=params$lang == "en", echo=params$lang == "en"}
str_glue("{fmt_count(surv, is.na(date_onset))} are missing date of onset and not shown.")
```

```{r, eval=params$lang == "fr", echo=params$lang == "fr"}
str_glue("{fmt_count(surv, is.na(date_onset))} cas n'ont pas de date d'apparition et ne sont pas présentés ici.")
```

```{r, eval=params$lang == "ru", echo=params$lang == "ru"}
str_glue("{fmt_count(surv, is.na(date_onset))} случаев дата начала заболевания отсутствует и не показана.")
```

```{r, eval=params$lang == "es", echo=params$lang == "es"}
str_glue("{fmt_count(surv, is.na(date_onset))} falta la fecha de inicio y no se muestra.")
```

--

{scales}

```{r, eval=params$lang == "en", echo=params$lang == "en"}
str_glue("There were {comma(sum(as.numeric(surv$diff), na.rm=T))} total delay days between symptom onset and report.")

```

```{r, eval=params$lang == "fr", echo=params$lang == "fr"}
str_glue("Il y avait {comma(sum(as.numeric(surv$diff), na.rm=T))} jours de retard total entre l'apparition des symptômes et la déclaration.")

```

```{r, eval=params$lang == "ru", echo=params$lang == "ru"}
str_glue("Между началом симптомов и сообщением о них прошло {comma(sum(as.numeric(surv$diff), na.rm=T))} всего дней задержки.")

```

```{r, eval=params$lang == "es", echo=params$lang == "es"}
str_glue("Hubo {comma(sum(as.numeric(surv$diff), na.rm=T))} días totales de retraso entre el inicio de los síntomas y el informe")

```

---

# Tableaux statiques

Ceci est écrit dans ton R markdown :

```
Column 1 |Column  2 |Column 3
---------|----------|--------
Cell A   |Cell B    |Cell C
Cell D   |Cell E    |Cell F
```

produit ceci :

| Colonne 1 | Colonne 2 | Colonne 3 | 
| --------- | --------- | --------- |
| Cellule A | Cellule B | Cellule C | 
| Cellule D | Cellule E | Cellule F | 

Les tableaux dynamiques peuvent être créés à l'aide de logiciels tels que {flextable} et {DT}.

---

# Mode source

Ton script pourrait ressembler à ceci :

```{r, eval=TRUE, echo=FALSE, out.width="80%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("source_mode_", params$lang, ".png"))))
```

---

# Mode visuel

RStudio te permet d'éditer en "mode visuel", qui ressemble à un document Word.

```{r, eval=TRUE, echo=FALSE, out.width="80%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", paste0("visual_mode_", params$lang, ".png"))))
```

???
Si écrire le document en code est intimidant, RStudio te permet de faire basculer le script en "mode visuel", de sorte que ton document ressemble à un document Word.

---

# `params`

Dans le YAML, tu peux définir `params` pour qu'il soit disponible pour le rapport :

```{asis}
---
title: "Surveillance report"
output: html_document
params:
 date: "2021-04-10"
 hospital: "Central Hospital"
---
```

Tu peux créer les noms de ces paramètres

---

# `params`

Dans le R Markdown, appelle-les `params` dans ton code en utilisant : `params$`

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "5_parameterized_1.png")))
```

---

# `params`

Dans le R Markdown, appelle-les `params` dans ton code en utilisant : `params$`

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "5_parameterized_2.png")))
```

---

# `params`

Dans le R Markdown, appelle-les `params` dans ton code en utilisant : `params$`

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "5_parameterized_3.png")))
```

---

# `params`

.pull-left[

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "5_parameterized_menu_1.png")))
```

]

.pull-right[

```{r, eval=TRUE, echo=FALSE, out.width="100%"}
knitr::include_graphics(xfun::relative_path(here::here("images", "rmarkdown", "5_parameterized_menu_2.png")))
```

]

---

# Modèles de rapports

Tu peux fournir des modèles R Markdown avec Word ou PPT (par exemple avec des logos, etc.).

Une fois le rapport rendu, tu peux modifier le texte pour y ajouter des interprétations.

Applied Epi collabore avec Médecins sans frontières (MSF) pour proposer des modèles R Markdown pour les rapports de situation :

- Choléra/diarrhée aqueuse aiguë
- Méningite
- Rougeole/Rubéole
- Syndrome de jaunisse aiguë (souvent soupçonné d'être l'hépatite E)

et pour l'analyse de l'enquête :

- Mortalité rétrospective et accès aux soins.
- Couverture vaccinale
- Malnutrition

---

# Éclatements

<!-- --- -->

<!-- # code R en ligne -->

<!-- A partir de -->

<!-- `` `r knitr::inline_expr("format(Sys.Date())")` ``, il y avait -->

<!-- `` `r knitr::inline_expr("nrow(surv)")` `` cas confirmés.   -->

<!-- En date du -->

<!-- `` `r knitr::inline_expr("format(Sys.Date(), '%d %B, %Y')")` ``, il y avait -->

<!-- `` `r knitr::inline_expr("nrow(surv)")` ` ` cas confirmés.   -->

<!-- Produit ceci :   -->

<!-- Au `r format(Sys.Date(), '%d %B, %Y')`, il y avait `r nrow(surv)` cas confirmés.   -->

<!-- --- -->


